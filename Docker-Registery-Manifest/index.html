<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Docker Registry manifest 分析 - Kira's Blog</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Kira's Blog" property="og:site_name">
  
    <meta content="Docker Registry manifest 分析" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Docker Registry manifest 代码分析" property="og:description">
  
  
    <meta content="/Docker-Registery-Manifest/" property="og:url">
  
  
    <meta content="2016-10-20T04:33:11+00:00" property="article:published_time">
    <meta content="/about/" property="article:author">
  
  
    <meta content="/imkira.com/assets/img/avatar.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="Docker" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="Docker Registry manifest 分析">
  
  
    <meta name="twitter:url" content="/Docker-Registery-Manifest/">
  
  
    <meta name="twitter:description" content="Docker Registry manifest 代码分析">
  
  
    <meta name="twitter:image:src" content="/imkira.com/assets/img/avatar.jpg">
  

	<meta name="description" content="Docker Registry manifest 代码分析">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/imkira.com/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/imkira.com/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/imkira.com/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/imkira.com/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/imkira.com/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/imkira.com/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/imkira.com/"><img src="/imkira.com/assets/img/avatar.jpg" alt="Wei Guo"></a>
      </div>
      <div class="author-name">Wei Guo</div>
      <p>Author of Nirvana API Framewark. Focus on CloudNative technologies.</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
        
          <li class="github"><a href="http://github.com/kdada" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:me@imkira.com"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2019 &copy; Wei Guo</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Docker Registry manifest 分析</h1>
        <div class="page-date"><span>2016, Oct 20&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h4 id="分析环境">分析环境：</h4>
<p>distribution：https://github.com/docker/distribution<br />
branch：release/2.5</p>

<h4 id="1imagemanifestdispatcher">1.imageManifestDispatcher</h4>
<p>imageManifestDispatcher 是注册在 <a href="http://imkira.com/a6.html">App</a> 内的 Dispatcher，实现了处理 Manifest 的方法的调度方法。Dispatcher 处理 /v2/{name}/manifests/{reference} 形式的请求（/registry/api/v2/desriptors.go#491），并生成对应于不同 Http Method 的 Handler，最终交由 Handler 处理请求。<br />
imageManifestDispatcher：/registry/handlers/images.go#30</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// imageManifestDispatcher 根据请求的类型生成相应的 Handler</span>
<span class="k">func</span> <span class="n">imageManifestDispatcher</span><span class="p">(</span><span class="n">ctx</span> <span class="o">*</span><span class="n">Context</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
    <span class="n">imageManifestHandler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">imageManifestHandler</span><span class="p">{</span>
        <span class="n">Context</span><span class="o">:</span> <span class="n">ctx</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c">//reference 为 repo 的的 tag 或 manifest 的标识符</span>
    <span class="n">reference</span> <span class="o">:=</span> <span class="n">getReference</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="c">// 检查 refrence 是否能够转换为 Digest(manifest 的标识符是 Digest 形式的字符串)</span>
    <span class="n">dgst</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">digest</span><span class="o">.</span><span class="n">ParseDigest</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="c">// 如果 reference 格式不符, 则视 reference 为 Tag</span>
        <span class="n">imageManifestHandler</span><span class="o">.</span><span class="n">Tag</span> <span class="o">=</span> <span class="n">reference</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c">// 如果 reference 格式符合, 则视 reference 为 Digest</span>
        <span class="n">imageManifestHandler</span><span class="o">.</span><span class="n">Digest</span> <span class="o">=</span> <span class="n">dgst</span>
    <span class="p">}</span>
    <span class="c">// 添加 GET 和 HEAD 请求的 Handler</span>
    <span class="n">mhandler</span> <span class="o">:=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">MethodHandler</span><span class="p">{</span>
        <span class="s">"GET"</span><span class="o">:</span>  <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">imageManifestHandler</span><span class="o">.</span><span class="n">GetImageManifest</span><span class="p">),</span>
        <span class="s">"HEAD"</span><span class="o">:</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">imageManifestHandler</span><span class="o">.</span><span class="n">GetImageManifest</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="c">// 如果 readOnly 为 false 表示可以处理写请求, 则添加 PUT 和 DELETE 请求的 Handler</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">ctx</span><span class="o">.</span><span class="n">readOnly</span> <span class="p">{</span>
        <span class="c">//PutImageManifest 上传并存储 Manifest, 并根据请求的参数设置 Tag</span>
        <span class="n">mhandler</span><span class="p">[</span><span class="s">"PUT"</span><span class="p">]</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">imageManifestHandler</span><span class="o">.</span><span class="n">PutImageManifest</span><span class="p">)</span>
        <span class="c">//DeleteImageManifest 从 registry 中删除指定的以及其关联的 Manifest</span>
        <span class="c">// 同时将与 Manifest 关联的各个 Tag 一并删除</span>
        <span class="n">mhandler</span><span class="p">[</span><span class="s">"DELETE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">imageManifestHandler</span><span class="o">.</span><span class="n">DeleteImageManifest</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">mhandler</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="2imagemanifestdispatcher-contextrepository-属性分析">2.imageManifestDispatcher context.Repository 属性分析</h4>
<p>imageManifestDispatcher 在 App.register 中被 App.dispatcher 包装，并生成关键的 Context 对象</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// dispatcher:/registry/handlers/app.go#592</span>
<span class="k">func</span> <span class="p">(</span><span class="n">app</span> <span class="o">*</span><span class="n">App</span><span class="p">)</span> <span class="n">dispatcher</span><span class="p">(</span><span class="n">dispatch</span> <span class="n">dispatchFunc</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="c">//nameRequired 用于检查当前请求是否需要使用 name 属性</span>
        <span class="c">//imageManifestDispatcher 使用 name 属性作为 repo 名称, 因此会为该请求的 Context 创建 repository 等信息</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">nameRequired</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">//getName 获取 url 中的 name 信息, 该 name 为 repo 的名称</span>
            <span class="n">nameRef</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">reference</span><span class="o">.</span><span class="n">ParseNamed</span><span class="p">(</span><span class="n">getName</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
            <span class="o">...</span>

            <span class="c">//registry 为 storage.registry:/registry/storage/registry.go#14</span>
            <span class="c">// 使用 registry 创建 repository,repository 为 storage.repository:/registry/storage/registry.go#158</span>
            <span class="c">//repository.name 为 repo 的名称</span>
            <span class="n">repository</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">app</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">nameRef</span><span class="p">)</span>
            <span class="o">...</span>

            <span class="c">// 该 context 为 handlers.Context:/registry/handlers/context.go</span>
            <span class="n">context</span><span class="o">.</span><span class="n">Repository</span> <span class="o">=</span> <span class="n">notifications</span><span class="o">.</span><span class="n">Listen</span><span class="p">(</span>
                <span class="n">repository</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">eventBridge</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
            <span class="o">...</span>
        <span class="p">}</span>
        <span class="c">// 将 context 传递给 dispatch, 此时 context 内部包含了 registry,repository 实例</span>
        <span class="n">dispatch</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">...</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="c">// Manifests 根据当前的 repo 生成 ManifestService /registry/storage/registry.go#182</span>
<span class="k">func</span> <span class="p">(</span><span class="n">repo</span> <span class="o">*</span><span class="n">repository</span><span class="p">)</span> <span class="n">Manifests</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">options</span> <span class="o">...</span><span class="n">distribution</span><span class="o">.</span><span class="n">ManifestServiceOption</span><span class="p">)</span> <span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">ManifestService</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>

    <span class="c">//blob 存储实例, 用于读取 blob</span>
    <span class="n">blobStore</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">linkedBlobStore</span><span class="p">{</span>
        <span class="n">ctx</span><span class="o">:</span>                  <span class="n">ctx</span><span class="p">,</span>
        <span class="n">blobStore</span><span class="o">:</span>            <span class="n">repo</span><span class="o">.</span><span class="n">blobStore</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">:</span>           <span class="n">repo</span><span class="p">,</span>
        <span class="n">deleteEnabled</span><span class="o">:</span>        <span class="n">repo</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">deleteEnabled</span><span class="p">,</span>
        <span class="n">blobAccessController</span><span class="o">:</span> <span class="n">statter</span><span class="p">,</span>

        <span class="c">// TODO(stevvooe): linkPath limits this blob store to only</span>
        <span class="c">// manifests. This instance cannot be used for blob checks.</span>
        <span class="n">linkPathFns</span><span class="o">:</span>           <span class="n">manifestLinkPathFns</span><span class="p">,</span>
        <span class="n">linkDirectoryPathSpec</span><span class="o">:</span> <span class="n">manifestDirectoryPathSpec</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c">// 创建 manifestStore, 用于读取 manifest</span>
    <span class="n">ms</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">manifestStore</span><span class="p">{</span>
        <span class="n">ctx</span><span class="o">:</span>        <span class="n">ctx</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">:</span> <span class="n">repo</span><span class="p">,</span>
        <span class="n">blobStore</span><span class="o">:</span>  <span class="n">blobStore</span><span class="p">,</span>
        <span class="n">schema1Handler</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">signedManifestHandler</span><span class="p">{</span>
            <span class="n">ctx</span><span class="o">:</span>        <span class="n">ctx</span><span class="p">,</span>
            <span class="n">repository</span><span class="o">:</span> <span class="n">repo</span><span class="p">,</span>
            <span class="n">blobStore</span><span class="o">:</span>  <span class="n">blobStore</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">schema2Handler</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">schema2ManifestHandler</span><span class="p">{</span>
            <span class="n">ctx</span><span class="o">:</span>        <span class="n">ctx</span><span class="p">,</span>
            <span class="n">repository</span><span class="o">:</span> <span class="n">repo</span><span class="p">,</span>
            <span class="n">blobStore</span><span class="o">:</span>  <span class="n">blobStore</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">manifestListHandler</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">manifestListHandler</span><span class="p">{</span>
            <span class="n">ctx</span><span class="o">:</span>        <span class="n">ctx</span><span class="p">,</span>
            <span class="n">repository</span><span class="o">:</span> <span class="n">repo</span><span class="p">,</span>
            <span class="n">blobStore</span><span class="o">:</span>  <span class="n">blobStore</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="o">...</span>

    <span class="k">return</span> <span class="n">ms</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// Get 获取指定的 manifest /registry/storage/manifeststore.go#70</span>
<span class="k">func</span> <span class="p">(</span><span class="n">ms</span> <span class="o">*</span><span class="n">manifestStore</span><span class="p">)</span> <span class="n">Get</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">dgst</span> <span class="n">digest</span><span class="o">.</span><span class="n">Digest</span><span class="p">,</span> <span class="n">options</span> <span class="o">...</span><span class="n">distribution</span><span class="o">.</span><span class="n">ManifestServiceOption</span><span class="p">)</span> <span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">Manifest</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// 获取 Digest 指向的数据</span>
    <span class="n">content</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ms</span><span class="o">.</span><span class="n">blobStore</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dgst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">distribution</span><span class="o">.</span><span class="n">ErrBlobUnknown</span> <span class="p">{</span>
            <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">distribution</span><span class="o">.</span><span class="n">ErrManifestUnknownRevision</span><span class="p">{</span>
                <span class="n">Name</span><span class="o">:</span>     <span class="n">ms</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">Named</span><span class="p">()</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span>
                <span class="n">Revision</span><span class="o">:</span> <span class="n">dgst</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="c">// 将读取出的 content 解析到 Versioned 实例</span>
    <span class="k">var</span> <span class="n">versioned</span> <span class="n">manifest</span><span class="o">.</span><span class="n">Versioned</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">versioned</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="c">// 根据版本解析到不同的类型中</span>
    <span class="k">switch</span> <span class="n">versioned</span><span class="o">.</span><span class="n">SchemaVersion</span> <span class="p">{</span>
    <span class="k">case</span> <span class="m">1</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">schema1Handler</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dgst</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">case</span> <span class="m">2</span><span class="o">:</span>
        <span class="c">// This can be an image manifest or a manifest list</span>
        <span class="k">switch</span> <span class="n">versioned</span><span class="o">.</span><span class="n">MediaType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">schema2</span><span class="o">.</span><span class="n">MediaTypeManifest</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">schema2Handler</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dgst</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">manifestlist</span><span class="o">.</span><span class="n">MediaTypeManifestList</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">manifestListHandler</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dgst</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">distribution</span><span class="o">.</span><span class="n">ErrManifestVerification</span><span class="p">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"unrecognized manifest content type %s"</span><span class="p">,</span> <span class="n">versioned</span><span class="o">.</span><span class="n">MediaType</span><span class="p">)}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"unrecognized manifest schema version %d"</span><span class="p">,</span> <span class="n">versioned</span><span class="o">.</span><span class="n">SchemaVersion</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="3imagemanifesthandlergetimagemanifest-获取-image-的-manifest-兼容性分析">3.imageManifestHandler.GetImageManifest 获取 image 的 manifest 兼容性分析</h4>
<p>一个 manifest 范例：</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nl">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
   </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.container.image.v1+json"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2941</span><span class="p">,</span><span class="w">
      </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:c1061fcd6f18076c66e3136c2b7b0671d8dac53069db5e645fe5c41bd1c720df"</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="nl">"layers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">70591526</span><span class="p">,</span><span class="w">
         </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:8d30e94188e7f13642d975e70c484e48c33867f3ede3277df1145803fa996ac1"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">1074069567</span><span class="p">,</span><span class="w">
         </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:4682f625c356560bd2dc2f26dfc9af5ded0fb0aa5e301e1afd33c38340acf95a"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">1074069566</span><span class="p">,</span><span class="w">
         </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:d138e90cf64401783f3682e74c519ecb33dd020298a90c7ae737cdf98f334258"</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// GetImageManifest 获取指定 image 的 manifest</span>
<span class="k">func</span> <span class="p">(</span><span class="n">imh</span> <span class="o">*</span><span class="n">imageManifestHandler</span><span class="p">)</span> <span class="n">GetImageManifest</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ctxu</span><span class="o">.</span><span class="n">GetLogger</span><span class="p">(</span><span class="n">imh</span><span class="p">)</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"GetImageManifest"</span><span class="p">)</span>
    <span class="c">// 从 Repository 中获取 Manifests 服务</span>
    <span class="n">manifests</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">imh</span><span class="o">.</span><span class="n">Repository</span><span class="o">.</span><span class="n">Manifests</span><span class="p">(</span><span class="n">imh</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">imh</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">imh</span><span class="o">.</span><span class="n">Errors</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="n">manifest</span> <span class="n">distribution</span><span class="o">.</span><span class="n">Manifest</span>
    <span class="k">if</span> <span class="n">imh</span><span class="o">.</span><span class="n">Tag</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
        <span class="c">// 如果 Tag 不为空, 则说明请求传递了 Tag</span>
        <span class="c">// 根据 Tag 获取对应的 Digest</span>
        <span class="n">tags</span> <span class="o">:=</span> <span class="n">imh</span><span class="o">.</span><span class="n">Repository</span><span class="o">.</span><span class="n">Tags</span><span class="p">(</span><span class="n">imh</span><span class="p">)</span>
        <span class="n">desc</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">tags</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">imh</span><span class="p">,</span> <span class="n">imh</span><span class="o">.</span><span class="n">Tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">imh</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">imh</span><span class="o">.</span><span class="n">Errors</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">ErrorCodeManifestUnknown</span><span class="o">.</span><span class="n">WithDetail</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">imh</span><span class="o">.</span><span class="n">Digest</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">Digest</span>
    <span class="p">}</span>
    <span class="o">...</span>
    
    <span class="c">// 无论请求传递的 refrence 是 Tag 还是 Digest, 到这里都会变成 Digest</span>
    <span class="c">// 根据 Digest 获取指定的 manifest</span>
    <span class="n">manifest</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">manifests</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">imh</span><span class="p">,</span> <span class="n">imh</span><span class="o">.</span><span class="n">Digest</span><span class="p">,</span> <span class="n">options</span><span class="o">...</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">imh</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">imh</span><span class="o">.</span><span class="n">Errors</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">ErrorCodeManifestUnknown</span><span class="o">.</span><span class="n">WithDetail</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c">// 根据请求头的 Accept 检查客户端对 Schema2 和 ManifestList 的支持情况</span>
    <span class="n">supportsSchema2</span> <span class="o">:=</span> <span class="no">false</span>
    <span class="n">supportsManifestList</span> <span class="o">:=</span> <span class="no">false</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">acceptHeader</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">r</span><span class="o">.</span><span class="n">Header</span><span class="p">[</span><span class="s">"Accept"</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mediaType</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">strings</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">acceptHeader</span><span class="p">,</span> <span class="s">","</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">mediaType</span><span class="p">,</span> <span class="s">";"</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
                <span class="n">mediaType</span> <span class="o">=</span> <span class="n">mediaType</span><span class="p">[</span><span class="o">:</span><span class="n">i</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">mediaType</span> <span class="o">=</span> <span class="n">strings</span><span class="o">.</span><span class="n">TrimSpace</span><span class="p">(</span><span class="n">mediaType</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mediaType</span> <span class="o">==</span> <span class="n">schema2</span><span class="o">.</span><span class="n">MediaTypeManifest</span> <span class="p">{</span>
                <span class="n">supportsSchema2</span> <span class="o">=</span> <span class="no">true</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">mediaType</span> <span class="o">==</span> <span class="n">manifestlist</span><span class="o">.</span><span class="n">MediaTypeManifestList</span> <span class="p">{</span>
                <span class="n">supportsManifestList</span> <span class="o">=</span> <span class="no">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c">// 检查 manifests.Get 返回的 manifest 的类型, registry 默认用 Schema2 进行存储</span>
    <span class="n">schema2Manifest</span><span class="p">,</span> <span class="n">isSchema2</span> <span class="o">:=</span> <span class="n">manifest</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">schema2</span><span class="o">.</span><span class="n">DeserializedManifest</span><span class="p">)</span>
    <span class="n">manifestList</span><span class="p">,</span> <span class="n">isManifestList</span> <span class="o">:=</span> <span class="n">manifest</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">manifestlist</span><span class="o">.</span><span class="n">DeserializedManifestList</span><span class="p">)</span>

    <span class="c">// 检查 manifest 的版本以及客户端支持的版本</span>
    <span class="k">if</span> <span class="n">imh</span><span class="o">.</span><span class="n">Tag</span> <span class="o">!=</span> <span class="s">""</span> <span class="o">&amp;&amp;</span> <span class="n">isSchema2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">supportsSchema2</span> <span class="p">{</span>
        <span class="c">// 如果当前 manifest 是 Schema2 的同时客户端不支持, 则使用 convertSchema2Manifest 方法将 manifest 转换为 Schema1 的版本</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">imh</span><span class="o">.</span><span class="n">convertSchema2Manifest</span><span class="p">(</span><span class="n">schema2Manifest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">imh</span><span class="o">.</span><span class="n">Tag</span> <span class="o">!=</span> <span class="s">""</span> <span class="o">&amp;&amp;</span> <span class="n">isManifestList</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">supportsManifestList</span> <span class="p">{</span>
        <span class="c">// 如果当前 manifest 是 ManifestList 的同时客户端不支持, 则选择默认 OS 版本的 manifest 的返回</span>
        <span class="k">var</span> <span class="n">manifestDigest</span> <span class="n">digest</span><span class="o">.</span><span class="n">Digest</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">manifestDescriptor</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">manifestList</span><span class="o">.</span><span class="n">Manifests</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">manifestDescriptor</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">Architecture</span> <span class="o">==</span> <span class="n">defaultArch</span> <span class="o">&amp;&amp;</span> <span class="n">manifestDescriptor</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">OS</span> <span class="o">==</span> <span class="n">defaultOS</span> <span class="p">{</span>
                <span class="n">manifestDigest</span> <span class="o">=</span> <span class="n">manifestDescriptor</span><span class="o">.</span><span class="n">Digest</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">manifestDigest</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
            <span class="n">imh</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">imh</span><span class="o">.</span><span class="n">Errors</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">ErrorCodeManifestUnknown</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">manifest</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">manifests</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">imh</span><span class="p">,</span> <span class="n">manifestDigest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">imh</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">imh</span><span class="o">.</span><span class="n">Errors</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">ErrorCodeManifestUnknown</span><span class="o">.</span><span class="n">WithDetail</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c">// 如果当前 manifest 是 Schema2 的同时客户端不支持, 则使用 convertSchema2Manifest 方法将 manifest 转换为 Schema1 的版本</span>
        <span class="k">if</span> <span class="n">schema2Manifest</span><span class="p">,</span> <span class="n">isSchema2</span> <span class="o">:=</span> <span class="n">manifest</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">schema2</span><span class="o">.</span><span class="n">DeserializedManifest</span><span class="p">);</span> <span class="n">isSchema2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">supportsSchema2</span> <span class="p">{</span>
            <span class="n">manifest</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">imh</span><span class="o">.</span><span class="n">convertSchema2Manifest</span><span class="p">(</span><span class="n">schema2Manifest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c">// 生成 manifest 数据返回给客户端</span>
    <span class="n">ct</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">Payload</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="n">w</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Content-Length"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
    <span class="n">w</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Docker-Content-Digest"</span><span class="p">,</span> <span class="n">imh</span><span class="o">.</span><span class="n">Digest</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">w</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Etag"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">`"%s"`</span><span class="p">,</span> <span class="n">imh</span><span class="o">.</span><span class="n">Digest</span><span class="p">))</span>
    <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<p>备注：Schema2 只返回了简单的 manifest, 还需要根据 config.digest 属性中指定的 sha256 值获取详细的信息, 而经过 convertSchema2Manifest 转换成 Schema1 版本的 manifest 已经包含了详细信息。</p>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=Docker Registry manifest 分析&url=/Docker-Registery-Manifest/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=/Docker-Registery-Manifest/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=/Docker-Registery-Manifest/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/imkira.com/tags#Docker" class="tag">&#35; Docker</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
