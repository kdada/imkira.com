<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>使用 Docker 搭建 Keepalived 高可用集群 - Kira's Blog</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Kira's Blog" property="og:site_name">
  
    <meta content="使用 Docker 搭建 Keepalived 高可用集群" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="使用 Docker 搭建 Keepalived 高可用集群" property="og:description">
  
  
    <meta content="https://imkira.com/Docker-Keepalived-HA/" property="og:url">
  
  
    <meta content="2016-12-26T01:25:05+00:00" property="article:published_time">
    <meta content="https://imkira.com/about/" property="article:author">
  
  
    <meta content="https://imkira.com/assets/img/avatar.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="Docker" property="article:tag">
    
    <meta content="Keepalived" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="使用 Docker 搭建 Keepalived 高可用集群">
  
  
    <meta name="twitter:url" content="https://imkira.com/Docker-Keepalived-HA/">
  
  
    <meta name="twitter:description" content="使用 Docker 搭建 Keepalived 高可用集群">
  
  
    <meta name="twitter:image:src" content="https://imkira.com/assets/img/avatar.jpg">
  

	<meta name="description" content="使用 Docker 搭建 Keepalived 高可用集群">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/avatar.jpg" alt="Wei Guo"></a>
      </div>
      <div class="author-name">Wei Guo</div>
      <p>Author of Nirvana API Framewark. Focus on CloudNative technologies.</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
        
          <li class="github"><a href="http://github.com/kdada" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:me@imkira.com"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2025 &copy; Wei Guo</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">使用 Docker 搭建 Keepalived 高可用集群</h1>
        <div class="page-date"><span>2016, Dec 26&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h4 id="keepalived-镜像构建">KeepAlived 镜像构建</h4>
<p>Dockerfile 文件如下：</p>
<pre><code class="language-Dockerfile">FROM debian:jessie

RUN apt-get update &amp;&amp;\
    apt-get install -y keepalived

ADD ./entrypoint.sh /entrypoint.sh

RUN chmod +x /entrypoint.sh

ENTRYPOINT /entrypoint.sh

CMD keepalived -l -n -D

</code></pre>

<p>entrypoint.sh 启动脚本:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>
<p>启动脚本只是简单地将参数作为命令执行，如果有需要，可以在该脚本中做一些检查或者其它必要处理。<br />
特别注意：启动脚本必须使用 exec 命令启动 keepalived ，否则会导致在使用 docker stop 等命令停止容器时，Keepalived 无法正确关闭。</p>

<p>原因：</p>
<ol>
  <li>docker stop 在停止容器时，会先向容器发送 SIGTERM 信号，然后等待容器中进程 ID 为 1 的进程主动退出。如果容器 10 秒（默认值，可修改）内没有退出，
 docker 会发送 SIGKILL 强制关闭进程。</li>
  <li>使用 exec 启动的命令将会继承当前的 shell 脚本的 PID ，但是进程会被替换为 exec 执行的那个命令的进程。 也就是说，进程 ID 不变，但是进程已经是新的进程了。</li>
  <li>shell 进程不会主动处理 SIGTERM 信号，导致 shell 进程会被强制关闭，同时 keepalived 进程也会因此被强制关闭。使用 exec 后 shell 进程被 keepalived 
 进程替换，而 keepalived 进程能够处理信号，因此能够正常的关闭退出。</li>
</ol>

<p>不正常关闭可能会出现以下问题（重启可解决）：</p>
<ul>
  <li>容器再启动时会一直处于重启中状态</li>
  <li>无法启动一个新的 keepalived</li>
</ul>

<p>将启动脚本和 Dockerfile 放置在同一目录之后即可使用 docker 命令构建：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -t keepalived .
</code></pre></div></div>

<h4 id="keepalived-配置">KeepAlived 配置</h4>
<p>配置如下：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vrrp_script check <span class="o">{</span>
    script <span class="s2">"python /etc/keepalived/check.py"</span> 
    interval 5
    weight <span class="nt">-3</span>
    fall 2  
    rise 1
<span class="o">}</span>

vrrp_instance server <span class="o">{</span>
    state BACKUP
    interface eth0
    virtual_router_id 72
    priority 100
    nopreempt
    advert_int 1
    authentication <span class="o">{</span>
        auth_type PASS
        auth_pass Hf9saFkj
    <span class="o">}</span>
    virtual_ipaddress <span class="o">{</span>
        10.0.0.33
    <span class="o">}</span>
    track_script <span class="o">{</span>
        check
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>vrrp_script 节定义了一个脚本，字段含义如下：</p>
<ul>
  <li>script：脚本命令，通常可以用来执行一个脚本</li>
  <li>interval：调用间隔时间，以秒为单位</li>
  <li>weight：权重，脚本返回非 0 值时，priority += weight</li>
  <li>fall: 当脚本连续返回 fall 次非 0 值时，就认为当前节点处于失败状态</li>
  <li>rise：当脚本连续返回 rise 次 0 值时，就认为当前节点处于正常状态</li>
</ul>

<p>vrrp_instance 定义了一个节点，字段含义如下：</p>
<ul>
  <li>state：初始状态，即 Keepalived 刚启动时的状态。如果想要搭建单主的集群，
 那么最好所有节点都设置为 BACKUP ，这样 Keepalived 会自动选举出 master 节点</li>
  <li>interface：网卡接口名称</li>
  <li>virtual_router_id：标志当前节点的路由 id ，同一个路由 id 的节点为一个组</li>
  <li>priority：优先级 1 - 255 。在同一时间，最高优先级的节点能够抢占并成为 master 节点，其它低优先级的节点需要让出 master</li>
  <li>nopreempt：如果设置了该选项，则表示即使存在低优先级的节点处于 master 状态，也不会去抢占</li>
  <li>advert_int：广播间隔，以秒为单位。即每隔 advert_int 秒发送一次通知广播，告诉其他节点当前节点的状态</li>
  <li>authentication：鉴权选项，用于同组之间的节点校验身份。此处使用密码鉴权，auth_pass 最长 8 位</li>
  <li>virtual_ipaddress：Virtual IP 组，可以设置多个 VIP ， master 节点拥有 VIP 的使用权</li>
  <li>track_script：健康检查脚本，在这个字段中定义的脚本会用来调整当前节点的 priority</li>
</ul>

<h4 id="keepalived-启动">KeepAlived 启动</h4>
<p>使用如下命令启动：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d --restart always --privileged --network=host -v /path/to/keepalived/config:/etc/keepalived keepalived
</code></pre></div></div>
<p>需要使用 privileged 启动并且必须是 host 网络。</p>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=使用 Docker 搭建 Keepalived 高可用集群&url=https://imkira.com/Docker-Keepalived-HA/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://imkira.com/Docker-Keepalived-HA/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://imkira.com/Docker-Keepalived-HA/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#Docker" class="tag">&#35; Docker</a>
          
            <a href="/tags#Keepalived" class="tag">&#35; Keepalived</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
